---
import { formatDate } from '../../i18n/utils';

interface Writeup {
  id?: string;
  slug: string;
  collection?: string;
  data: {
    title: string;
    description: string;
    pubDate: Date;
    platform: string;
    difficulty: 'easy' | 'medium' | 'hard' | 'insane';
    os: string;
    tags?: string[];
    language: string;
    heroImage?: string;
    logo?: string;
  };
}

interface Props {
  writeups: Writeup[];
  title: string;
  lang: string;
}

const { writeups, title, lang } = Astro.props;

// Mapeo de colores por dificultad
const difficultyColors: Record<'easy' | 'medium' | 'hard' | 'insane', string> = {
  easy: '#10b981',
  medium: '#f59e0b',
  hard: '#ef4444',
  insane: '#8b5cf6'
};

// Mapeo de plataformas
const platformNames: Record<string, string> = {
  htb: 'HackTheBox',
  hackthebox: 'HackTheBox',
  thm: 'TryHackMe',
  tryhackme: 'TryHackMe',
  vulnhub: 'VulnHub',
  hackmyvm: 'HackMyVM',
  portswigger: 'PortSwigger',
  ctf: 'CTF',
  other: 'Other'
};

// Mapeo de plataforma a ruta URL
const platformToUrl: Record<string, string> = {
  htb: 'hackthebox',
  hackthebox: 'hackthebox',
  thm: 'tryhackme',
  tryhackme: 'tryhackme',
  vulnhub: 'vulnhub',
  hackmyvm: 'hackmyvm',
  portswigger: 'portswigger',
  ctf: 'ctf',
  other: 'other'
};

// Generar URL correcta para writeups
const getWriteupUrl = (writeup: Writeup) => {
  // El slug viene como "es/hackthebox/codify" o "en/tryhackme/blue"
  const slugParts = writeup.slug.split('/');
  
  // slugParts[0] = idioma (es/en)
  // slugParts[1] = plataforma (hackthebox/tryhackme/etc)
  // slugParts[2+] = nombre de la mÃ¡quina
  
  if (slugParts.length >= 3) {
    const platform = slugParts[1]; // hackthebox, tryhackme, vulnhub, etc.
    const machineName = slugParts.slice(2).join('/'); // codify, blue, etc.
    return `/${lang}/writeup/${platform}/${machineName}`;
  }
  
  // Fallback
  const cleanedSlug = writeup.slug.replace(/^(es|en)\//, '');
  return `/${lang}/writeup/${cleanedSlug}`;
};
---

{writeups.length > 0 && (
  <section class="my-12 py-8 border-t-2 border-slate-200 dark:border-slate-700" aria-labelledby="related-heading">
    <h2 id="related-heading" class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-8">
      {title}
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {writeups.map((writeup) => {
        const writeupUrl = getWriteupUrl(writeup);
        return (
        <article class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden transition-all duration-300 hover:-translate-y-2 hover:shadow-xl hover:border-indigo-500 dark:hover:border-indigo-400 h-full group cursor-pointer">
          <a 
            href={writeupUrl} 
            class="flex flex-col h-full no-underline text-inherit relative"
            title={`Ver writeup: ${writeup.data.title}`}
          >
            {writeup.data.heroImage ? (
              <div class="w-full h-44 overflow-hidden bg-gradient-to-br from-indigo-600 to-purple-600 relative">
                <img 
                  src={writeup.data.heroImage} 
                  alt={writeup.data.title}
                  loading="lazy"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                />
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                  <span class="text-white text-4xl opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                    ğŸ‘‰
                  </span>
                </div>
              </div>
            ) : writeup.data.logo ? (
              <div class="w-full h-44 overflow-hidden bg-gradient-to-br from-indigo-600 to-purple-600 relative">
                <img 
                  src={writeup.data.logo} 
                  alt={writeup.data.title}
                  loading="lazy"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                />
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                  <span class="text-white text-4xl opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                    ğŸ‘‰
                  </span>
                </div>
              </div>
            ) : (
              <div class="w-full h-44 flex items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-600 relative">
                <span class="text-6xl opacity-90 transition-transform duration-300 group-hover:scale-110">
                  {writeup.data.platform === 'htb' ? 'ğŸ¯' : 
                   writeup.data.platform === 'tryhackme' ? 'ğŸ”’' :
                   writeup.data.platform === 'vulnhub' ? 'ğŸ“¦' :
                   writeup.data.platform === 'hackmyvm' ? 'ğŸ’»' : 'ğŸ–¥ï¸'}
                </span>
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                  <span class="text-white text-4xl opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                    ğŸ‘‰
                  </span>
                </div>
              </div>
            )}
            
            <div class="p-5 flex flex-col flex-grow gap-1">
              <div class="flex flex-wrap gap-2 mb-3">
                <span class={`badge platform-${writeup.data.platform}`} data-platform={writeup.data.platform}>
                  {platformNames[writeup.data.platform] || writeup.data.platform.toUpperCase()}
                </span>
                <span class={`badge difficulty-${writeup.data.difficulty}`}>
                  {writeup.data.difficulty.charAt(0).toUpperCase() + writeup.data.difficulty.slice(1)}
                </span>
              </div>
              
              <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-2 line-clamp-2 leading-snug group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors duration-200">
                {writeup.data.title}
              </h3>
              
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-3 leading-relaxed flex-grow">
                {writeup.data.description}
              </p>
              
              <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400 mt-auto pt-3 border-t border-slate-200 dark:border-slate-700">
                <time datetime={writeup.data.pubDate.toISOString()}>
                  {formatDate(writeup.data.pubDate, lang)}
                </time>
                <div class="flex items-center gap-2">
                  <span class="text-lg">
                    {writeup.data.os === 'linux' ? 'ğŸ§' : writeup.data.os === 'windows' ? 'ğŸªŸ' : 'ğŸ’»'}
                  </span>
                  <span class="text-indigo-500 dark:text-indigo-400 font-semibold opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-x-1 group-hover:translate-x-0">
                    Ver â†’
                  </span>
                </div>
              </div>
            </div>
          </a>
        </article>
        );
      })}
    </div>
  </section>
)}
