---
import { getCollection } from 'astro:content';
import WriteupLayout from '../../../../layouts/WriteupLayout.astro';
import TOC from '../../../../components/common/TOC.astro';
import RelatedWriteups from '../../../../components/writeup/RelatedWriteups.astro';
import { formatDate } from '../../../../i18n/utils';
import { useTranslations } from '../../../../i18n/core';

export async function getStaticPaths() {
  const writeupEntries = await getCollection('writeups', ({ data }) => {
    return data.platform === 'tryhackme';
  });
  
  return writeupEntries.map(entry => {
    // El slug viene como: "es/tryhackme/blue"
    // Necesitamos solo: "blue" (sin idioma ni plataforma)
    const slugParts = entry.slug.split('/');
    const actualSlug = slugParts.slice(2).join('/'); // Elimina idioma Y plataforma
    const lang = entry.data.language || 'es';
    
    return {
      params: { lang: lang, slug: actualSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const t = useTranslations(entry.data.language as 'es' | 'en');

// Obtener writeups relacionados de TryHackMe
const allWriteups = await getCollection('writeups', ({ data }) => {
  return data.language === entry.data.language && data.platform === 'tryhackme';
});

const currentTags = entry.data.tags || [];
const currentCategory = entry.data.category;
const currentDifficulty = entry.data.difficulty;

// Buscar relacionados por similitud
const related = allWriteups
  .filter(w => w.slug !== entry.slug)
  .map(w => ({
    writeup: w,
    score: 
      (w.data.category === currentCategory ? 3 : 0) +
      (w.data.difficulty === currentDifficulty ? 2 : 0) +
      (w.data.tags?.filter(t => currentTags.includes(t)).length || 0)
  }))
  .filter(({ score }) => score > 0)
  .sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return new Date(b.writeup.data.pubDate).getTime() - new Date(a.writeup.data.pubDate).getTime();
  })
  .slice(0, 3)
  .map(({ writeup }) => writeup);

if (related.length < 3) {
  const remaining = allWriteups
    .filter(w => w.slug !== entry.slug && !related.includes(w))
    .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
    .slice(0, 3 - related.length);
  related.push(...remaining);
}

const difficultyColors = {
  easy: '#10b981',
  medium: '#f59e0b',
  hard: '#ef4444',
  insane: '#8b5cf6'
};

const categoryNames: Record<string, string> = {
  rooms: entry.data.language === 'es' ? 'Sala' : 'Room',
  paths: entry.data.language === 'es' ? 'Path' : 'Path',
  challenges: entry.data.language === 'es' ? 'DesafÃ­o' : 'Challenge'
};
---

<WriteupLayout
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.language}
  image={entry.data.heroImage}
  pubDate={entry.data.pubDate}
  updatedDate={entry.data.updatedDate}
  platform={entry.data.platform}
  difficulty={entry.data.difficulty}
  os={entry.data.os}
  tags={entry.data.tags}
  retired={entry.data.retired}
>
  <article class="tryhackme-post">
    <header class="post-header">
      {entry.data.heroImage && (
        <div class="hero-image">
          <div class="image-wrapper">
            <img src={entry.data.heroImage} alt={entry.data.title} />
          </div>
        </div>
      )}
      
      <div class="post-meta-wrapper">
        <div class="breadcrumb">
          <a href={`/${entry.data.language}/writeup`}>{t('writeups.title')}</a>
          <span class="separator">/</span>
          <a href={`/${entry.data.language}/writeup/tryhackme`}>TryHackMe</a>
          {entry.data.category && (
            <>
              <span class="separator">/</span>
              <a href={`/${entry.data.language}/writeup/tryhackme/${entry.data.category}`}>
                {categoryNames[entry.data.category] || entry.data.category}
              </a>
            </>
          )}
        </div>

        <h1 class="post-title">{entry.data.title}</h1>
        
        <div class="post-badges">
          <span class="badge badge-platform">
            ğŸ“ TryHackMe
          </span>
          {entry.data.category && (
            <span class="badge badge-category">
              {entry.data.category === 'rooms' && 'ğŸšª'}
              {entry.data.category === 'paths' && 'ğŸ›¤ï¸'}
              {entry.data.category === 'challenges' && 'ğŸ†'}
              {' '}
              {categoryNames[entry.data.category] || entry.data.category}
            </span>
          )}
          <span 
            class="badge badge-difficulty" 
            style={`background-color: ${difficultyColors[entry.data.difficulty]}20; color: ${difficultyColors[entry.data.difficulty]}; border: 1.5px solid ${difficultyColors[entry.data.difficulty]};`}
          >
            {entry.data.difficulty.charAt(0).toUpperCase() + entry.data.difficulty.slice(1)}
          </span>
          {entry.data.os && (
            <span class="badge badge-os">
              {entry.data.os === 'linux' ? 'ğŸ§ Linux' : entry.data.os === 'windows' ? 'ğŸªŸ Windows' : 'ğŸ’» ' + entry.data.os}
            </span>
          )}
          {entry.data.retired && (
            <span class="badge badge-retired">
              {t('writeups.retired')}
            </span>
          )}
        </div>

        <div class="post-meta">
          <time datetime={entry.data.pubDate.toISOString()}>
            ğŸ“… {formatDate(entry.data.pubDate, entry.data.language)}
          </time>
          {entry.data.updatedDate && (
            <span class="updated">
              Â· ğŸ”„ {t('blog.updated_on')}: {formatDate(entry.data.updatedDate, entry.data.language)}
            </span>
          )}
          {entry.data.estimatedTime && (
            <span class="estimated-time">
              Â· â±ï¸ {entry.data.estimatedTime}
            </span>
          )}
          {entry.data.points && (
            <span class="points">
              Â· ğŸ† {entry.data.points} pts
            </span>
          )}
        </div>

        {/* InformaciÃ³n adicional especÃ­fica de TryHackMe */}
        {(entry.data.attackVectors || entry.data.certifications || entry.data.vulnerabilities) && (
          <div class="additional-info">
            {entry.data.attackVectors && entry.data.attackVectors.length > 0 && (
              <div class="info-section">
                <strong>
                  ğŸ¯ {entry.data.language === 'es' ? 'Vectores de Ataque' : 'Attack Vectors'}
                </strong>
                <div class="vectors">
                  {entry.data.attackVectors.map((vector) => (
                    <span class="vector-badge">{vector.replace('-', ' ')}</span>
                  ))}
                </div>
              </div>
            )}
            
            {entry.data.certifications && entry.data.certifications.length > 0 && (
              <div class="info-section">
                <strong>
                  ğŸ“ {entry.data.language === 'es' ? 'Certificaciones Relacionadas' : 'Related Certifications'}
                </strong>
                <div class="certs">
                  {entry.data.certifications.map((cert) => (
                    <span class="cert-badge">{cert}</span>
                  ))}
                </div>
              </div>
            )}

            {entry.data.vulnerabilities && entry.data.vulnerabilities.length > 0 && (
              <div class="info-section">
                <strong>
                  ğŸ”“ {entry.data.language === 'es' ? 'Vulnerabilidades' : 'Vulnerabilities'}
                </strong>
                <div class="vulns">
                  {entry.data.vulnerabilities.map((vuln) => (
                    <span class="vuln-badge">{vuln}</span>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="tags">
            {entry.data.tags.map((tag) => (
              <a 
                href={`/${entry.data.language}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="tag"
              >
                #{tag}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>

    <!-- Content & TOC -->
    <div class="content-container">
      <div class="content-wrapper">
        <div class="main-content prose">
          <Content />
        </div>
      </div>
    </div>

    <!-- TOC Fixed (fuera del flujo) -->
    {headings.length > 0 && (
      <aside class="toc-wrapper">
        <TOC headings={headings} title={t('writeups.table_of_contents')} inline={false} platform="thm" />
      </aside>
    )}

    {related.length > 0 && (
      <section class="related-section">
        <RelatedWriteups 
          writeups={related as any} 
          title={t('writeups.related_writeups')}
          lang={entry.data.language}
        />
      </section>
    )}
  </article>
</WriteupLayout>

<style>
  .tryhackme-post {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
    position: relative;
  }

  .post-header {
    max-width: 1280px; /* max-w-7xl - alineado con header/footer */
    margin: 0 auto 3rem;
    position: relative;
    z-index: 5;
    padding: 0 1rem;
    animation: fadeInDown 0.6s ease-out;
  }

  @media (min-width: 640px) {
    .post-header {
      padding: 0 2rem;
    }
  }

  /* DecoraciÃ³n de fondo con gradiente morado de TryHackMe */
  .tryhackme-post::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 400px;
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.03) 0%, 
      rgba(109, 40, 217, 0.02) 50%,
      transparent 100%
    );
    z-index: -1;
    pointer-events: none;
  }

  .related-section {
    max-width: 1200px;
    margin: 4rem auto 0;
    padding: 3rem 1rem 0;
    border-top: 2px solid rgba(124, 58, 237, 0.1);
    position: relative;
    z-index: 5;
  }

  @media (min-width: 640px) {
    .related-section {
      padding: 3rem 2rem 0;
    }
  }

  .hero-image {
    max-width: 100%;
    margin: 0 auto 1.5rem;
    position: relative;
    perspective: 1000px;
  }

  @media (min-width: 640px) {
    .hero-image {
      max-width: 600px;
      margin-bottom: 2rem;
    }
  }

  .image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    box-shadow: 
      0 20px 60px rgba(124, 58, 237, 0.15),
      0 0 0 1px rgba(124, 58, 237, 0.1);
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.05) 0%, 
      rgba(109, 40, 217, 0.05) 100%
    );
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .image-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.1), 
      transparent 50%
    );
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1;
  }

  .hero-image:hover .image-wrapper {
    transform: translateY(-8px) rotateX(2deg);
    box-shadow: 
      0 30px 80px rgba(124, 58, 237, 0.25),
      0 0 0 1px rgba(124, 58, 237, 0.2);
  }

  .hero-image:hover .image-wrapper::before {
    opacity: 1;
  }

  .image-wrapper img {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    position: relative;
    z-index: 0;
  }

  .post-meta-wrapper {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 0.5rem;
  }

  @media (min-width: 640px) {
    .post-meta-wrapper {
      padding: 0 1rem;
    }
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.05), 
      rgba(109, 40, 217, 0.03)
    );
    overflow-x: auto;
    white-space: nowrap;
    border-radius: 10px;
    border: 1.5px solid rgba(124, 58, 237, 0.15);
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
  }

  @media (min-width: 640px) {
    .breadcrumb {
      font-size: 0.9375rem;
      margin-bottom: 1.25rem;
      padding: 0.875rem 1.25rem;
    }
  }

  .breadcrumb a {
    color: #7c3aed;
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 600;
  }

  .breadcrumb a:hover {
    color: #6d28d9;
    text-decoration: underline;
  }

  .separator {
    color: rgba(124, 58, 237, 0.4);
    opacity: 0.7;
  }

  .post-title {
    font-size: 1.75rem;
    font-weight: 900;
    line-height: 1.2;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--text-color), #7c3aed);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.02em;
  }

  @media (min-width: 640px) {
    .post-title {
      font-size: 2rem;
      margin-bottom: 1.25rem;
    }
  }

  @media (min-width: 768px) {
    .post-title {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
    }
  }

  .post-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 640px) {
    .post-badges {
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 700;
    letter-spacing: 0.01em;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  @media (min-width: 640px) {
    .badge {
      padding: 0.5rem 1.125rem;
      border-radius: 10px;
      font-size: 0.9375rem;
    }
  }

  .badge-platform {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white;
    box-shadow: 
      0 4px 12px rgba(124, 58, 237, 0.3),
      0 0 0 1px rgba(124, 58, 237, 0.2);
  }

  .badge-platform:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 6px 20px rgba(124, 58, 237, 0.4),
      0 0 0 1px rgba(124, 58, 237, 0.3);
  }

  .badge-category {
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.15), 
      rgba(109, 40, 217, 0.1)
    );
    color: #7c3aed;
    border: 1.5px solid rgba(124, 58, 237, 0.3);
    font-weight: 700;
  }

  .badge-category:hover {
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.25), 
      rgba(109, 40, 217, 0.15)
    );
    border-color: #7c3aed;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
  }

  .badge-difficulty {
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .badge-difficulty:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }

  .badge-os {
    background: var(--bg-secondary);
    color: var(--text-color);
    border: 2px solid var(--border-color);
    font-weight: 600;
  }

  .badge-os:hover {
    background: rgba(124, 58, 237, 0.1);
    border-color: #7c3aed;
    color: #7c3aed;
    transform: translateY(-2px);
  }

  .badge-retired {
    background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
    color: #f59e0b;
    border: 2px solid #f59e0b;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.8;
    }
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    color: var(--text-muted);
    font-size: 0.9375rem;
    margin-bottom: 1.5rem;
    font-weight: 500;
  }

  .updated, .estimated-time, .points {
    color: var(--text-muted);
  }

  .additional-info {
    background: linear-gradient(135deg, 
      rgba(124, 58, 237, 0.03) 0%, 
      rgba(109, 40, 217, 0.02) 100%
    );
    border: 2px solid rgba(124, 58, 237, 0.15);
    border-radius: 16px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    box-shadow: 
      0 4px 12px rgba(124, 58, 237, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }

  .additional-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, #7c3aed, #6d28d9);
    border-radius: 4px 0 0 4px;
  }

  .info-section {
    margin-bottom: 1.25rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid rgba(124, 58, 237, 0.1);
  }

  .info-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .info-section strong {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-color);
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .vectors, .certs, .vulns {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
  }

  .vector-badge, .cert-badge, .vuln-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: rgba(124, 58, 237, 0.1);
    color: #7c3aed;
    border: 1.5px solid rgba(124, 58, 237, 0.3);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: capitalize;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: default;
  }

  .vector-badge:hover {
    background: rgba(124, 58, 237, 0.2);
    border-color: #7c3aed;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
  }

  .cert-badge {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border-color: rgba(16, 185, 129, 0.3);
  }

  .cert-badge:hover {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
  }

  .vuln-badge {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.3);
  }

  .vuln-badge:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: #ef4444;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: rgba(124, 58, 237, 0.08);
    color: #7c3aed;
    border: 1.5px solid rgba(124, 58, 237, 0.2);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .tag:hover {
    background: #7c3aed;
    border-color: #7c3aed;
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(124, 58, 237, 0.3);
  }

  /* ========================================================================
     CONTENT LAYOUT - Igual que Blog con TOC a la derecha
     ======================================================================== */

  .content-container {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
  }

  .content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }

  .main-content {
    width: 100%;
    position: relative;
    z-index: 1;
  }

  .toc-wrapper {
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    overflow: visible;
    z-index: 10;
    pointer-events: none;
  }

  .toc-wrapper > :global(*) {
    pointer-events: auto;
  }

  .prose {
    width: 100%;
    position: relative;
    z-index: 1;
  }

  /* Estilos para el contenido con el tema TryHackMe */
  .prose :global(h2) {
    border-bottom: 3px solid rgba(124, 58, 237, 0.2);
    padding-bottom: 0.5rem;
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
  }

  .prose :global(h2::before) {
    content: '';
    display: inline-block;
    width: 4px;
    height: 24px;
    background: linear-gradient(180deg, #7c3aed, #6d28d9);
    margin-right: 0.75rem;
    border-radius: 2px;
    vertical-align: middle;
  }

  .prose :global(a) {
    color: #7c3aed;
    text-decoration: none;
    border-bottom: 2px solid rgba(124, 58, 237, 0.3);
    transition: all 0.2s ease;
  }

  .prose :global(a:hover) {
    color: #6d28d9;
    border-bottom-color: #6d28d9;
  }

  .prose :global(code) {
    background: rgba(124, 58, 237, 0.08);
    border: 1px solid rgba(124, 58, 237, 0.2);
  }

  .post-content :global(pre) {
    border: 2px solid rgba(124, 58, 237, 0.15);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.08);
  }

  .post-content :global(blockquote) {
    border-left: 4px solid #7c3aed;
    background: rgba(124, 58, 237, 0.05);
  }

  .related-wrapper {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 2px solid rgba(124, 58, 237, 0.1);
  }

  @media (max-width: 768px) {
    .post-content :global(h2::before) {
      display: none;
    }
  }
</style>
