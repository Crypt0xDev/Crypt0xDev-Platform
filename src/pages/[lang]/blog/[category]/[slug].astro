---
import { getCollection } from 'astro:content';
import BlogLayout from '@layouts/BlogLayout.astro';
import TOC from '@components/common/TOC.astro';
import Breadcrumb from '@components/common/Breadcrumb.astro';
import RelatedPosts from '@components/common/RelatedPosts.astro';
import { formatDate } from '@i18n/utils';
import { useTranslations } from '@i18n/core';
import { BLOG_CATEGORIES } from '@i18n/constants/categories';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => {
    const slugParts = entry.slug.split('/');
    const lang = slugParts[0] || entry.data.language || 'es';
    const category = slugParts[1] || entry.data.category || 'tutorial';
    const actualSlug = slugParts[2] || slugParts[slugParts.length - 1];
    
    return {
      params: { lang: lang, category: category, slug: actualSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const t = useTranslations(entry.data.language as 'es' | 'en');

// Obtener información de la categoría
const categoryInfo = entry.data.category && BLOG_CATEGORIES[entry.data.category];

// Obtener posts relacionados
const allPosts = await getCollection('blog', ({ data }) => {
  return data.language === entry.data.language;
});

const currentTags = entry.data.tags || [];

// Buscar relacionados por tags
const related = allPosts
  .filter(p => p.slug !== entry.slug) // Excluir el actual
  .map(p => ({
    post: p,
    // Calcular score de similitud basado en tags compartidos
    score: p.data.tags?.filter(t => currentTags.includes(t)).length || 0
  }))
  .filter(({ score }) => score > 0) // Solo mostrar si hay tags en común
  .sort((a, b) => {
    // Primero por score, luego por fecha
    if (b.score !== a.score) return b.score - a.score;
    return new Date(b.post.data.pubDate).getTime() - new Date(a.post.data.pubDate).getTime();
  })
  .slice(0, 3) // Top 3
  .map(({ post }) => post);

// Si no hay suficientes posts relacionados por tags, completar con los más recientes
if (related.length < 3) {
  const remaining = allPosts
    .filter(p => p.slug !== entry.slug && !related.includes(p))
    .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
    .slice(0, 3 - related.length);
  related.push(...remaining);
}
---

<BlogLayout
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.language}
  image={entry.data.heroImage}
  pubDate={entry.data.pubDate}
  updatedDate={entry.data.updatedDate}
  tags={entry.data.tags}
>
  <article class="blog-post">
    <!-- Breadcrumb -->
    <Breadcrumb items={[
      { label: entry.data.language === 'es' ? 'Inicio' : 'Home', href: `/${entry.data.language}` },
      { label: 'Blog', href: `/${entry.data.language}/blog` },
      ...(categoryInfo ? [{ label: categoryInfo.label[entry.data.language as 'es' | 'en'], href: `/${entry.data.language}/blog/${entry.data.category}` }] : []),
      { label: entry.data.title }
    ]} />
    
    <header class="post-header">
      <div class="post-meta-wrapper">
        <!-- Categoría y Dificultad -->
        <div class="flex items-center justify-center gap-3 mb-6 flex-wrap">
          {categoryInfo && (
            <a 
              href={`/${entry.data.language}/blog/${entry.data.category}`}
              class={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold ${categoryInfo.color} no-underline hover:opacity-80 transition-all border border-current`}
            >
              <span>{categoryInfo.icon}</span>
              {categoryInfo.label[entry.data.language as 'es' | 'en']}
            </a>
          )}
          {entry.data.difficulty && (
            <span class={`inline-flex items-center px-4 py-2 rounded-full text-sm font-bold border ${
              entry.data.difficulty === 'beginner' ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 border-green-300 dark:border-green-700' :
              entry.data.difficulty === 'intermediate' ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-400 border-yellow-300 dark:border-yellow-700' :
              'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400 border-red-300 dark:border-red-700'
            }`}>
              {entry.data.difficulty === 'beginner' ? (entry.data.language === 'es' ? 'Principiante' : 'Beginner') :
               entry.data.difficulty === 'intermediate' ? (entry.data.language === 'es' ? 'Intermedio' : 'Intermediate') :
               (entry.data.language === 'es' ? 'Avanzado' : 'Advanced')}
            </span>
          )}
        </div>
        
        <h1 class="post-title">{entry.data.title}</h1>
        
        <div class="post-meta">
          <time datetime={entry.data.pubDate.toISOString()} class="text-slate-600 dark:text-slate-400">
            {formatDate(entry.data.pubDate, entry.data.language)}
          </time>
          {entry.data.updatedDate && (
            <span class="text-slate-600 dark:text-slate-400">
              · {entry.data.language === 'es' ? 'Actualizado' : 'Updated'}: {formatDate(entry.data.updatedDate, entry.data.language)}
            </span>
          )}
        </div>
        
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="tags">
            {entry.data.tags.map((tag: string) => (
              <a 
                href={`/${entry.data.language}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="tag"
              >
                #{tag}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>

    <div class="content-layout">
      <div class="content-wrapper">
        <article class="prose" data-pagefind-ignore>
          <Content />
        </article>
      </div>

      {headings.length > 2 && (
        <aside class="toc-sidebar" data-pagefind-ignore>
          <TOC headings={headings} title={t('blog.table_of_contents') || 'Table of Contents'} platform="blog" />
        </aside>
      )}
    </div>

    <div class="related-section" data-pagefind-ignore>
      <RelatedPosts 
        posts={related.map(post => ({
          id: post.id,
          slug: post.slug,
          title: post.data.title,
          description: post.data.description,
          pubDate: post.data.pubDate,
          heroImage: post.data.heroImage,
          tags: post.data.tags,
          language: post.data.language,
          readTime: post.data.readTime,
          category: post.data.category
        }))} 
        title={t('blog.related_posts') || 'Related Posts'} 
        lang={entry.data.language}
        type="blog"
      />
    </div>
  </article>
</BlogLayout>

<style>
  .blog-post {
    max-width: 1280px;
    margin: 0 auto;
    padding: 2rem;
  }

  .post-header {
    max-width: 1280px;
    margin: 0 auto 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.15);
  }

  .post-meta-wrapper {
    text-align: center;
  }

  .post-title {
    font-size: clamp(2rem, 5vw, 2.75rem);
    font-weight: 800;
    margin: 1.5rem 0 1rem;
    color: var(--text-color, #0f172a);
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .post-meta {
    font-size: 0.9rem;
    color: var(--text-muted, #64748b);
    margin-top: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.25rem;
  }

  .tag {
    padding: 0.35rem 0.85rem;
    background: rgba(148, 163, 184, 0.08);
    border: 1px solid rgba(148, 163, 184, 0.15);
    border-radius: 9999px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #64748b;
    text-decoration: none;
    transition: all 0.2s;
  }

  .tag:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.3);
    color: #667eea;
  }

  .content-layout {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    margin-bottom: 2rem;
  }

  .content-wrapper {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
  }

  .toc-sidebar {
    position: fixed;
    top: 6rem;
    right: max(1rem, calc((100vw - 1280px) / 2 - 300px));
    width: 280px;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    z-index: 40;
  }

  @media (max-width: 1680px) {
    .toc-sidebar {
      display: none;
    }
  }

  .related-section {
    max-width: 1280px;
    margin: 4rem auto 0;
    padding: 3rem 2rem 0;
    border-top: 1px solid rgba(148, 163, 184, 0.15);
  }

  /* Prose Styles */
  .prose {
    color: var(--text-color, #1e293b);
    line-height: 1.75;
    font-size: 1rem;
    max-width: none !important;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4),
  .prose :global(h5),
  .prose :global(h6) {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .prose :global(h2) {
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.15);
    color: var(--text-color, #0f172a);
  }

  .prose :global(h3) {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--text-color, #0f172a);
  }

  .prose :global(h4) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.75rem;
    margin-bottom: 0.5rem;
    color: var(--text-color, #0f172a);
  }

  .prose :global(p),
  .prose :global(li),
  .prose :global(td),
  .prose :global(th) {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  .prose :global(p) {
    margin-bottom: 1.5rem;
    line-height: 1.75;
  }

  .prose :global(a) {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .prose :global(a:hover) {
    color: #5568d3;
    text-decoration: underline;
  }

  .prose :global(code) {
    background: rgba(148, 163, 184, 0.1);
    color: #e11d48;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
  }

  .prose :global(pre) {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1.25rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.875rem;
    line-height: 1.7;
    border: 1px solid rgba(148, 163, 184, 0.1);
  }

  .prose :global(pre code) {
    background: transparent;
    color: inherit;
    padding: 0;
    font-weight: 400;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 1.5rem 0;
    padding-left: 1.75rem;
  }

  .prose :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose :global(blockquote) {
    border-left: 3px solid #667eea;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--text-muted, #64748b);
  }

  .prose :global(img) {
    border-radius: 8px;
    margin: 2rem auto;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.95rem;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid rgba(226, 232, 240, 0.8);
    padding: 0.65rem 0.85rem;
    text-align: left;
  }

  .prose :global(th) {
    background: rgba(248, 250, 252, 0.8);
    font-weight: 600;
  }

  /* Dark Mode */
  :global(.dark) .blog-post {
    --text-color: #f1f5f9;
    --text-muted: #94a3b8;
  }

  :global(.dark) .post-header {
    border-bottom-color: rgba(148, 163, 184, 0.1);
  }

  :global(.dark) .tag {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.2);
    color: #94a3b8;
  }

  :global(.dark) .tag:hover {
    background: rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.4);
    color: #a78bfa;
  }

  :global(.dark) .related-section {
    border-top-color: rgba(148, 163, 184, 0.1);
  }

  :global(.dark) .prose :global(h2) {
    border-bottom-color: rgba(102, 126, 234, 0.2);
  }

  :global(.dark) .prose :global(code) {
    background: rgba(148, 163, 184, 0.15);
    color: #fca5a5;
  }

  :global(.dark) .prose :global(th) {
    background: rgba(30, 41, 59, 0.5);
  }

  :global(.dark) .prose :global(th),
  :global(.dark) .prose :global(td) {
    border-color: rgba(148, 163, 184, 0.15);
  }

  @media (max-width: 768px) {
    .blog-post {
      padding: 1rem;
    }

    .post-title {
      font-size: 1.75rem;
    }

    .post-header {
      margin-bottom: 2rem;
    }
  }
</style>
