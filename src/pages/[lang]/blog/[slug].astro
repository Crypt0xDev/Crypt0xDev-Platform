---
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import TOC from '../../../components/common/TOC.astro';
import RelatedPosts from '../../../components/common/RelatedPosts.astro';
import { formatDate } from '../../../i18n/utils';
import { useTranslations } from '../../../i18n/core';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => {
    // El slug viene como "en/post-1" o "es/post-1", extraemos solo "post-1"
    const slugParts = entry.slug.split('/');
    const actualSlug = slugParts[slugParts.length - 1];
    // Usar entry.data.language que es el campo correcto del schema
    const lang = entry.data.language || 'es';
    
    return {
      params: { lang: lang, slug: actualSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const t = useTranslations(entry.data.language as 'es' | 'en');

// Obtener posts relacionados
const allPosts = await getCollection('blog', ({ data }) => {
  return data.language === entry.data.language;
});

const currentTags = entry.data.tags || [];

// Buscar relacionados por tags
const related = allPosts
  .filter(p => p.slug !== entry.slug) // Excluir el actual
  .map(p => ({
    post: p,
    // Calcular score de similitud basado en tags compartidos
    score: p.data.tags?.filter(t => currentTags.includes(t)).length || 0
  }))
  .filter(({ score }) => score > 0) // Solo mostrar si hay tags en común
  .sort((a, b) => {
    // Primero por score, luego por fecha
    if (b.score !== a.score) return b.score - a.score;
    return new Date(b.post.data.pubDate).getTime() - new Date(a.post.data.pubDate).getTime();
  })
  .slice(0, 3) // Top 3
  .map(({ post }) => post);

// Si no hay suficientes posts relacionados por tags, completar con los más recientes
if (related.length < 3) {
  const remaining = allPosts
    .filter(p => p.slug !== entry.slug && !related.includes(p))
    .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
    .slice(0, 3 - related.length);
  related.push(...remaining);
}
---

<BlogLayout
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.language}
  image={entry.data.heroImage}
  pubDate={entry.data.pubDate}
  updatedDate={entry.data.updatedDate}
  tags={entry.data.tags}
>
  <article class="blog-post">
    <header class="post-header">
      {entry.data.heroImage && (
        <div class="hero-image">
          <img src={entry.data.heroImage} alt={entry.data.title} />
        </div>
      )}
      
      <div class="post-meta-wrapper">
        <h1 class="post-title">{entry.data.title}</h1>
        <div class="post-meta">
          <time datetime={entry.data.pubDate.toISOString()}>
            {formatDate(entry.data.pubDate, entry.data.language)}
          </time>
          {entry.data.updatedDate && (
            <span class="updated">
              · Actualizado: {formatDate(entry.data.updatedDate, entry.data.language)}
            </span>
          )}
        </div>
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="tags">
            {entry.data.tags.map((tag: string) => (
              <a 
                href={`/${entry.data.language}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="tag"
              >
                {tag}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>

    <div class="content-container">
      <div class="content-wrapper">
        <div class="post-content prose" data-pagefind-ignore>
          <Content />
        </div>
      </div>

      {headings.length > 2 && (
        <aside class="toc-wrapper" data-pagefind-ignore>
          <TOC headings={headings} title={t('blog.table_of_contents') || 'Table of Contents'} />
        </aside>
      )}
    </div>

    <div class="related-wrapper" data-pagefind-ignore>
      <RelatedPosts 
        posts={related.map(post => ({
          id: post.id,
          slug: post.slug,
          title: post.data.title,
          description: post.data.description,
          pubDate: post.data.pubDate,
          heroImage: post.data.heroImage,
          tags: post.data.tags,
          language: post.data.language,
          readTime: post.data.readTime
        }))} 
        title={t('blog.related_posts') || 'Related Posts'} 
        lang={entry.data.language}
        type="blog"
      />
    </div>
  </article>
</BlogLayout>

<style>
  .blog-post {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
  }

  .post-header {
    max-width: 1200px;
    margin: 0 auto 3rem;
    position: relative;
    z-index: 5;
  }

  .content-container {
    position: relative;
    max-width: 1600px;
    margin: 0 auto;
  }

  .content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }

  .post-content {
    width: 100%;
    position: relative;
    z-index: 1;
  }

  .toc-wrapper {
    position: relative;
    z-index: 10;
  }

  .related-wrapper {
    max-width: 1200px;
    margin: 3rem auto 0;
    position: relative;
    z-index: 5;
  }

  .hero-image {
    width: 100%;
    height: auto;
    min-height: 400px;
    max-height: 600px;
    border-radius: 0.75rem;
    overflow: hidden;
    margin-bottom: 2rem;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
  }

  .post-meta-wrapper {
    text-align: center;
  }

  .post-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0 0 1rem;
    color: var(--text-color, #111827);
    line-height: 1.2;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    letter-spacing: -0.03em;
  }

  .post-meta {
    font-size: 0.875rem;
    color: var(--text-muted, #6b7280);
    margin-bottom: 1rem;
  }

  .updated {
    font-style: italic;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }

  .tag {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    background-color: var(--tag-bg, #f3f4f6);
    color: var(--tag-text, #4b5563);
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .tag:hover {
    background-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .post-content {
    color: var(--text-color, #374151);
    line-height: 1.8;
    font-size: 1.125rem;
    font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
    font-weight: 400;
  }

  /* Prose styles for markdown content */
  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4),
  .prose :global(h5),
  .prose :global(h6) {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: var(--text-color, #111827);
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    line-height: 1.3;
    letter-spacing: -0.02em;
  }

  .prose :global(h2) {
    font-size: 2.25rem;
    border-bottom: 2px solid var(--border-color, #e5e7eb);
    padding-bottom: 0.75rem;
    margin-top: 3rem;
  }

  .prose :global(h3) {
    font-size: 1.75rem;
    margin-top: 2.5rem;
  }

  .prose :global(p) {
    margin-bottom: 1.75rem;
    line-height: 1.9;
    font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
    font-size: 1.125rem;
    color: var(--text-color, #374151);
  }

  .prose :global(a) {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 500;
    font-family: 'Inter', sans-serif;
    transition: color 0.2s ease;
  }

  .prose :global(a:hover) {
    text-decoration: underline;
  }

  .prose :global(code) {
    background-color: var(--code-bg, #f3f4f6);
    color: var(--code-text, #e11d48);
    padding: 0.2rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.9em;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-weight: 500;
    border: 1px solid var(--border-color, #e5e7eb);
  }

  .prose :global(pre) {
    background-color: #282c34;
    color: #abb2bf;
    padding: 1.5rem;
    border-radius: 0.75rem;
    overflow-x: auto;
    margin: 2rem 0;
    font-size: 0.875rem;
    line-height: 1.7;
    border: 1px solid #3e4451;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
  }

  .prose :global(pre code) {
    background-color: transparent;
    color: inherit;
    padding: 0;
    font-size: inherit;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
    border: none;
    font-weight: 400;
  }

  /* Estilos específicos para Shiki */
  .prose :global(pre.shiki),
  .prose :global(pre.astro-code) {
    background-color: #282c34 !important;
    padding: 1.5rem;
    border-radius: 0.75rem;
    overflow-x: auto;
    tab-size: 2;
  }

  .prose :global(pre.shiki code),
  .prose :global(pre.astro-code code) {
    display: block;
    width: 100%;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 0.875rem;
    line-height: 1.7;
  }

  /* Scrollbar personalizado para código */
  .prose :global(pre::-webkit-scrollbar) {
    height: 8px;
  }

  .prose :global(pre::-webkit-scrollbar-track) {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
  }

  .prose :global(pre::-webkit-scrollbar-thumb) {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
  }

  .prose :global(pre::-webkit-scrollbar-thumb:hover) {
    background: rgba(255, 255, 255, 0.3);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 2rem 0;
    padding-left: 2.5rem;
    line-height: 1.9;
    font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
  }

  .prose :global(li) {
    margin-bottom: 0.75rem;
    font-size: 1.125rem;
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--accent-color);
    padding-left: 2rem;
    margin: 2rem 0;
    font-style: italic;
    color: var(--text-muted);
    font-size: 1.125rem;
    font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
    font-weight: 300;
  }

  .prose :global(img) {
    border-radius: 0.75rem;
    margin: 2.5rem 0;
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--border-color, #e5e7eb);
    padding: 0.75rem;
    text-align: left;
  }

  .prose :global(th) {
    background-color: var(--table-header-bg, #f9fafb);
    font-weight: 600;
  }

  :global(.dark) .blog-post {
    --text-color: #f9fafb;
    --text-muted: #9ca3af;
    --tag-bg: #374151;
    --tag-text: #d1d5db;
    --border-color: #374151;
    --code-bg: #374151;
    --code-text: #fb7185;
    --pre-bg: #111827;
    --pre-text: #f9fafb;
    --table-header-bg: #374151;
  }

  @media (max-width: 768px) {
    .post-title {
      font-size: 2rem;
    }

    .hero-image {
      height: 250px;
    }

    .blog-post {
      padding: 1rem;
    }
  }
</style>
