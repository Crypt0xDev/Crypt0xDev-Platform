---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { getLangFromUrl, useTranslations } from '../../i18n/core';
import { formatDate, sortByDate, filterByLang } from '../../i18n/utils';
import site from '../../content/site';

export function getStaticPaths() {
  return [
    { params: { lang: 'es' } },
    { params: { lang: 'en' } }
  ];
}

const { lang } = Astro.params;
const t = useTranslations(lang as 'es' | 'en');

const allPosts = await getCollection('blog');
const allWriteups = await getCollection('writeups');

const recentPosts = sortByDate(filterByLang(allPosts, lang as string)).slice(0, 3);
const recentWriteups = sortByDate(filterByLang(allWriteups, lang as string)).slice(0, 3);

// Meta description optimizada para SEO
const metaDescription = lang === 'es' 
  ? 'Aprende ciberseguridad con tutoriales, writeups de HackTheBox, TryHackMe, VulnHub y HackMyVM. Gu√≠as de pentesting y hacking √©tico en espa√±ol.'
  : 'Learn cybersecurity with tutorials, writeups from HackTheBox, TryHackMe, VulnHub and HackMyVM. Pentesting and ethical hacking guides in English.';

// Datos estructurados para SEO (Schema.org)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Crypt0xDev",
  "description": metaDescription,
  "url": `https://crypt0xdev.com/${lang}`,
  "inLanguage": lang,
  "author": {
    "@type": "Organization",
    "name": "Crypt0xDev"
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": `https://crypt0xdev.com/${lang}/search?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

const blogPostsStructuredData = recentPosts.map(post => ({
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "image": post.data.heroImage,
  "datePublished": post.data.pubDate.toISOString(),
  "author": {
    "@type": "Organization",
    "name": "Crypt0xDev"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Crypt0xDev"
  },
  "keywords": post.data.tags?.join(', ') || '',
  "articleSection": "Cybersecurity"
}));
---

<Layout title={t('nav.home')} description={metaDescription} lang={lang}>
  <!-- Datos estructurados para SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  {blogPostsStructuredData.map(data => (
    <script type="application/ld+json" set:html={JSON.stringify(data)} />
  ))}

  <main class="min-h-[calc(100vh-16rem)] bg-gradient-to-br from-white via-white to-indigo-50/20 dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950/10">
    <section class="relative py-12 md:py-16 bg-transparent overflow-hidden">
      <!-- Patr√≥n de puntos decorativo -->
      <div class="absolute inset-0 z-0" style="background-image: radial-gradient(circle, rgba(99, 102, 241, 0.15) 2px, transparent 2px); background-size: 40px 40px;"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-white/50 to-white dark:from-transparent dark:via-slate-900/50 dark:to-slate-900 z-0"></div>
      <div class="container max-w-4xl mx-auto px-4 relative z-10">
        <div class="text-center animate-fadeInDown">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-black mb-6 leading-tight font-sans tracking-tight">
            {t('common.welcome_to')} <span class="relative inline-block bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text text-transparent">
              Crypt0xDev
              <span class="absolute -bottom-1 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full shadow-lg shadow-purple-500/40"></span>
            </span>
          </h1>
          <h2 class="text-lg md:text-xl lg:text-2xl text-slate-600 dark:text-slate-400 leading-relaxed font-sans font-semibold mb-0">
            {t('common.hero_description')}
          </h2>
        </div>
      </div>
    </section>

    {recentPosts.length > 0 && (
      <section class="py-8 md:py-12 animate-fadeInUp" aria-labelledby="recent-posts-title">
        <div class="container max-w-7xl mx-auto px-4">
          <h2 id="recent-posts-title" class="text-3xl md:text-4xl lg:text-5xl font-black mb-8 font-sans tracking-tight bg-gradient-to-r from-slate-900 via-indigo-600 to-slate-900 dark:from-slate-100 dark:via-indigo-400 dark:to-slate-100 bg-clip-text text-transparent">
            {t('blog.latest_posts')}
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8" role="list">
            {recentPosts.map((post, index) => {
              const slugParts = post.slug.split('/');
              const actualSlug = (slugParts[0] === 'es' || slugParts[0] === 'en')
                ? slugParts[slugParts.length - 1]
                : post.slug;
              return (
                <article 
                  class="group bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-indigo-500/25 hover:border-indigo-500 flex flex-col relative animate-scaleIn shadow-md"
                  style={`animation-delay: ${index * 0.1}s`}
                  role="listitem"
                  itemscope 
                  itemtype="https://schema.org/BlogPosting"
                >
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  {post.data.heroImage && (
                    <div class="w-full h-52 overflow-hidden bg-gradient-to-br from-slate-100 to-indigo-100/50 dark:from-slate-800 dark:to-indigo-900/30">
                      <img 
                        src={post.data.heroImage} 
                        alt={post.data.title}
                        loading="lazy"
                        itemprop="image"
                        class="w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-110 block"
                      />
                    </div>
                  )}
                  <div class="p-6 lg:p-8 flex flex-col flex-1 gap-4">
                    <div class="flex items-center mb-2">
                      <time 
                        class="text-sm text-slate-600 dark:text-slate-400 font-medium font-sans" 
                        datetime={post.data.pubDate.toISOString()}
                        itemprop="datePublished"
                      >
                        {formatDate(post.data.pubDate, lang as string)}
                      </time>
                    </div>
                    <h3 class="text-xl lg:text-2xl font-extrabold m-0 leading-snug font-sans tracking-tight" itemprop="headline">
                      <a 
                        href={`/${lang}/blog/${actualSlug}`}
                        itemprop="url"
                        class="text-slate-900 dark:text-slate-50 no-underline hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-300 line-clamp-2"
                      >
                        {post.data.title}
                      </a>
                    </h3>
                    <p class="text-slate-600 dark:text-slate-400 m-0 leading-relaxed text-[15px] font-sans flex-1 line-clamp-3" itemprop="description">
                      {post.data.description}
                    </p>
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-2 mt-auto pt-4 border-t border-slate-200 dark:border-slate-800">
                        {post.data.tags.slice(0, 2).map((tag) => (
                          <a 
                            href={`/${lang}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                            class="tag"
                            rel="tag"
                            itemprop="keywords"
                          >
                            #{tag}
                          </a>
                        ))}
                      </div>
                    )}
                  </div>
                </article>
              );
            })}
          </div>
        </div>
      </section>
    )}

    {recentWriteups.length > 0 && (
      <section class="py-8 md:py-12 animate-fadeInUp" aria-labelledby="recent-writeups-title">
        <div class="container max-w-7xl mx-auto px-4">
          <h2 id="recent-writeups-title" class="text-3xl md:text-4xl lg:text-5xl font-black mb-8 font-sans tracking-tight bg-gradient-to-r from-slate-900 via-indigo-600 to-slate-900 dark:from-slate-100 dark:via-indigo-400 dark:to-slate-100 bg-clip-text text-transparent">
            {t('writeups.latest')}
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8" role="list">
            {recentWriteups.map((writeup, index) => {
              const slugParts = writeup.slug.split('/');
              const actualSlug = (slugParts[0] === 'es' || slugParts[0] === 'en')
                ? slugParts.slice(1).join('/')
                : writeup.slug;
              return (
                <article 
                  class="group bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-indigo-500/25 hover:border-indigo-500 flex flex-col relative animate-scaleIn shadow-md"
                  style={`animation-delay: ${index * 0.1}s`}
                  role="listitem"
                  itemscope 
                  itemtype="https://schema.org/TechArticle"
                >
                  <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  {writeup.data.heroImage && (
                    <div class="w-full h-52 overflow-hidden bg-gradient-to-br from-slate-100 to-indigo-100/50 dark:from-slate-800 dark:to-indigo-900/30">
                      <img 
                        src={writeup.data.heroImage} 
                        alt={writeup.data.title}
                        loading="lazy"
                        itemprop="image"
                        class="w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-110 block"
                      />
                    </div>
                  )}
                  <div class="p-6 lg:p-8 flex flex-col flex-1 gap-4">
                    <div class="flex flex-wrap gap-2 items-center">
                      <span 
                        class={`platform-${writeup.data.platform} inline-flex items-center px-3 lg:px-4 py-2 rounded-lg text-xs lg:text-sm font-extrabold font-sans uppercase tracking-wide leading-none border-2`}
                        data-platform={writeup.data.platform}
                        itemprop="about"
                      >
                        {writeup.data.platform.toUpperCase()}
                      </span>
                      <span 
                        class={`difficulty-${writeup.data.difficulty} inline-flex items-center px-3 lg:px-4 py-2 rounded-lg text-xs lg:text-sm font-bold font-sans capitalize leading-none border-2`}
                        itemprop="proficiencyLevel"
                      >
                        {t(`difficulty.${writeup.data.difficulty}`)}
                      </span>
                      {writeup.data.os && (
                        <span class="inline-flex items-center px-3 py-2 bg-gradient-to-br from-slate-100 to-slate-100/50 dark:from-slate-800/50 dark:to-slate-800/30 text-slate-600 dark:text-slate-400 border-2 border-slate-300/50 dark:border-slate-700/50 rounded-lg text-base lg:text-lg font-semibold font-sans leading-none" itemprop="operatingSystem">
                          {writeup.data.os === 'linux' ? 'üêß' : writeup.data.os === 'windows' ? 'ü™ü' : 'üíª'}
                        </span>
                      )}
                    </div>
                    
                    <h3 class="text-xl lg:text-2xl font-extrabold m-0 leading-snug font-sans tracking-tight" itemprop="headline">
                      <a 
                        href={`/${lang}/writeup/${actualSlug}`}
                        itemprop="url"
                        class="text-slate-900 dark:text-slate-50 no-underline hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-300 line-clamp-2"
                      >
                        {writeup.data.title}
                      </a>
                    </h3>
                    
                    <p class="text-slate-600 dark:text-slate-400 m-0 leading-relaxed text-[15px] font-sans flex-1 line-clamp-3" itemprop="description">
                      {writeup.data.description}
                    </p>
                    
                    <div class="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800">
                      {writeup.data.tags && writeup.data.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2">
                          {writeup.data.tags.slice(0, 4).map((tag) => (
                            <a 
                              href={`/${lang}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                              class="tag"
                              rel="tag"
                              itemprop="keywords"
                            >
                              #{tag}
                            </a>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </article>
              );
            })}
          </div>
        </div>
      </section>
    )}
  </main>
</Layout>
