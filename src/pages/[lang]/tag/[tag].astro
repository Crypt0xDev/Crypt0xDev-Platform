---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import { useTranslations } from '@i18n/core';
import { formatDate } from '@i18n/utils';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  const writeupEntries = await getCollection('writeups');
  
  const allEntries = [...blogEntries, ...writeupEntries];
  
  // Obtener todos los tags √∫nicos (incluyendo tags, attack vectors, techniques, certifications, vulnerabilities)
  const allTags = new Set<string>();
  
  allEntries.forEach(entry => {
    // Tags normales
    if (entry.data.tags && Array.isArray(entry.data.tags)) {
      entry.data.tags.forEach((tag: string) => allTags.add(tag));
    }
    
    // Para writeups, tambi√©n incluir otros campos
    const data = entry.data as any;
    
    if (data.attackVectors && Array.isArray(data.attackVectors)) {
      data.attackVectors.forEach((vector: string) => allTags.add(vector));
    }
    
    if (data.techniques && Array.isArray(data.techniques)) {
      data.techniques.forEach((tech: string) => allTags.add(tech));
    }
    
    if (data.certifications && Array.isArray(data.certifications)) {
      data.certifications.forEach((cert: string) => allTags.add(cert));
    }
    
    if (data.vulnerabilities && Array.isArray(data.vulnerabilities)) {
      data.vulnerabilities.forEach((vuln: string) => allTags.add(vuln));
    }
    
    // Agregar difficulty y os para writeups
    if (data.difficulty) {
      allTags.add(data.difficulty);
    }
    
    if (data.os) {
      allTags.add(data.os);
    }
  });

  // Crear rutas para cada combinaci√≥n de idioma y tag
  const paths: any[] = [];
  ['es', 'en'].forEach(lang => {
    allTags.forEach(tag => {
      paths.push({
        params: { lang, tag: tag.toLowerCase().replace(/\s+/g, '-') },
        props: { tag, lang }
      });
    });
  });

  return paths;
}

const { tag, lang } = Astro.props;
const t = useTranslations(lang as 'es' | 'en');

  // Funci√≥n helper para verificar si un entry tiene el tag
  const hasTag = (entry: any, tagToFind: string) => {
    const data = entry.data;
    
    // Buscar en tags
    if (data.tags && Array.isArray(data.tags) && data.tags.includes(tagToFind)) {
      return true;
    }
    
    // Buscar en attackVectors
    if (data.attackVectors && Array.isArray(data.attackVectors) && data.attackVectors.includes(tagToFind)) {
      return true;
    }
    
    // Buscar en techniques
    if (data.techniques && Array.isArray(data.techniques) && data.techniques.includes(tagToFind)) {
      return true;
    }
    
    // Buscar en certifications
    if (data.certifications && Array.isArray(data.certifications) && data.certifications.includes(tagToFind)) {
      return true;
    }
    
    // Buscar en vulnerabilities
    if (data.vulnerabilities && Array.isArray(data.vulnerabilities) && data.vulnerabilities.includes(tagToFind)) {
      return true;
    }
    
    // Buscar en difficulty
    if (data.difficulty && data.difficulty === tagToFind) {
      return true;
    }
    
    // Buscar en os
    if (data.os && data.os === tagToFind) {
      return true;
    }
    
    return false;
  };

// Obtener todas las entradas con este tag
const blogEntries = await getCollection('blog', ({ data }) => {
  return data.language === lang && hasTag({ data }, tag);
});

const writeupEntries = await getCollection('writeups', ({ data }) => {
  return data.language === lang && hasTag({ data }, tag);
});

// Combinar y ordenar por fecha
const allEntries = [...blogEntries, ...writeupEntries].sort((a, b) => {
  return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});

  // Encontrar el tag original (con may√∫sculas/min√∫sculas correctas)
  let originalTag = tag;
  allEntries.some(entry => {
    const data = entry.data as any;
    
    if (data.tags && Array.isArray(data.tags)) {
      const found = data.tags.find((t: string) => 
        t.toLowerCase().replace(/\s+/g, '-') === tag
      );
      if (found) {
        originalTag = found;
        return true;
      }
    }
    
    if (data.attackVectors && Array.isArray(data.attackVectors)) {
      const found = data.attackVectors.find((v: string) => 
        v.toLowerCase().replace(/\s+/g, '-') === tag
      );
      if (found) {
        originalTag = found;
        return true;
      }
    }
    
    if (data.techniques && Array.isArray(data.techniques)) {
      const found = data.techniques.find((t: string) => 
        t.toLowerCase().replace(/\s+/g, '-') === tag
      );
      if (found) {
        originalTag = found;
        return true;
      }
    }
    
    if (data.certifications && Array.isArray(data.certifications)) {
      const found = data.certifications.find((c: string) => 
        c.toLowerCase().replace(/\s+/g, '-') === tag
      );
      if (found) {
        originalTag = found;
        return true;
      }
    }
    
    if (data.vulnerabilities && Array.isArray(data.vulnerabilities)) {
      const found = data.vulnerabilities.find((v: string) => 
        v.toLowerCase().replace(/\s+/g, '-') === tag
      );
      if (found) {
        originalTag = found;
        return true;
      }
    }
    
    if (data.difficulty && data.difficulty.toLowerCase().replace(/\s+/g, '-') === tag) {
      originalTag = data.difficulty;
      return true;
    }
    
    if (data.os && data.os.toLowerCase().replace(/\s+/g, '-') === tag) {
      originalTag = data.os;
      return true;
    }
    
    return false;
  });
---

<Layout
  title={`${originalTag} - ${t('site.title')}`}
  description={`${t('blog.all_posts')} ${originalTag}`}
  lang={lang}
  canonical={Astro.url.href}
>
  <main class="tag-page">
    <div class="container">
      <header class="page-header">
        <div class="tag-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
            <line x1="7" y1="7" x2="7.01" y2="7"></line>
          </svg>
          {originalTag}
        </div>
        <h1 class="page-title">
          {allEntries.length} {allEntries.length === 1 ? (lang === 'es' ? 'publicaci√≥n con' : 'post with') : (lang === 'es' ? 'publicaciones con' : 'posts with')} "{originalTag}"
        </h1>
      </header>

      {allEntries.length === 0 ? (
        <div class="no-results">
          <p>{lang === 'es' ? 'No se encontraron publicaciones con este tag.' : 'No posts found with this tag.'}</p>
        </div>
      ) : (
        <div class="entries-grid">
          {allEntries.map((entry) => {
            const isWriteup = 'platform' in entry.data;
            const slugParts = entry.slug.split('/');
            const actualSlug = slugParts[slugParts.length - 1];
            const category = !isWriteup && entry.data.category ? entry.data.category : 'tutorial';
            const baseUrl = isWriteup ? `/${lang}/writeup` : `/${lang}/blog/${category}`;
            const machineName = entry.data.title.split(' - ')[0];
            const machineLogo = (entry.data as any).logo || entry.data.heroImage;
            const platform = isWriteup ? (entry.data as any).platform : null;
            
            return (
              <article class={`writeup-card group ${isWriteup ? 'bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800'} rounded-2xl overflow-hidden border transition-all duration-300 hover:shadow-2xl transform hover:-translate-y-2 hover:scale-105`}>
                {isWriteup && platform ? (
                  <>
                    {/* Logo circular con gradiente de plataforma */}
                    <div class="relative px-6 pt-8 pb-4 flex justify-center">
                      <div class="relative group-hover:scale-110 transition-transform duration-300">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full blur-md opacity-75 group-hover:opacity-100 animate-pulse"></div>
                        <div class="relative w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full p-1 group-hover:rotate-6 transition-transform duration-300">
                          <div class="w-full h-full bg-slate-900 rounded-full p-2 overflow-hidden">
                            <img 
                              src={machineLogo} 
                              alt={machineName}
                              class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Badges superiores */}
                    <div class="px-6 flex items-center justify-center gap-3 mb-4">
                      <span class="px-4 py-1.5 bg-blue-500/20 border border-blue-500/50 text-blue-400 rounded-full text-xs font-bold uppercase transition-all duration-300 hover:scale-110">
                        {platform?.toUpperCase()}
                      </span>
                      {'difficulty' in entry.data && (
                        <span class={`px-4 py-1.5 rounded-full text-xs font-bold uppercase transition-all duration-300 hover:scale-110 ${
                          entry.data.difficulty === 'easy' ? 'bg-emerald-500/20 border border-emerald-500/50 text-emerald-400' :
                          entry.data.difficulty === 'medium' ? 'bg-amber-500/20 border border-amber-500/50 text-amber-400' :
                          entry.data.difficulty === 'hard' ? 'bg-red-500/20 border border-red-500/50 text-red-400' :
                          'bg-purple-500/20 border border-purple-500/50 text-purple-400'
                        }`}>
                          {entry.data.difficulty}
                        </span>
                      )}
                      {'retired' in entry.data && entry.data.retired && (
                        <span class="px-4 py-1.5 bg-slate-500/20 border border-slate-500/50 text-slate-400 rounded-full text-xs font-bold uppercase">
                          {lang === 'es' ? 'Retirada' : 'Retired'}
                        </span>
                      )}
                    </div>
                    
                    {/* Contenido */}
                    <div class="px-6 pb-6">
                      <h2 class="text-xl font-bold text-white mb-2 text-center group-hover:text-blue-400 transition-colors duration-300">
                        <a href={`${baseUrl}/${actualSlug}`}>
                          {machineName}
                        </a>
                      </h2>
                      
                      <p class="text-sm text-slate-400 mb-4 line-clamp-2 text-center">
                        {entry.data.description}
                      </p>

                      {/* Metadata */}
                      <div class="flex items-center justify-center gap-4 mb-4 text-xs text-slate-400 flex-wrap">
                        {'os' in entry.data && (
                          <div class="flex items-center gap-1">
                            <span>{entry.data.os === 'linux' ? 'üêß' : entry.data.os === 'windows' ? 'ü™ü' : 'üíª'}</span>
                            <span class="capitalize">{entry.data.os}</span>
                          </div>
                        )}
                        {'difficulty' in entry.data && (
                          <div class="flex items-center gap-1">
                            <span>{entry.data.difficulty === 'easy' ? '‚óè' : entry.data.difficulty === 'medium' ? '‚óè‚óè' : entry.data.difficulty === 'hard' ? '‚óè‚óè‚óè' : '‚óè‚óè‚óè‚óè'}</span>
                            <span class="capitalize">{entry.data.difficulty}</span>
                          </div>
                        )}
                        {'points' in entry.data && entry.data.points && (
                          <div class="flex items-center gap-1">
                            <span>‚≠ê</span>
                            <span>{entry.data.points}</span>
                          </div>
                        )}
                        <div class="flex items-center gap-1">
                          <span>üìÖ</span>
                          <time datetime={entry.data.pubDate.toISOString()}>
                            {new Date(entry.data.pubDate).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
                              day: '2-digit',
                              month: 'short',
                              year: 'numeric'
                            })}
                          </time>
                        </div>
                      </div>
                      
                      {/* Tags */}
                      {entry.data.tags && entry.data.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 justify-center">
                          {entry.data.tags.slice(0, 3).map((t) => (
                            <a 
                              href={`/${lang}/tag/${t.toLowerCase().replace(/\s+/g, '-')}`}
                              class={`text-xs px-3 py-1 border rounded-full ${
                                t.toLowerCase().replace(/\s+/g, '-') === tag.toLowerCase().replace(/\s+/g, '-') 
                                  ? 'bg-indigo-500/40 border-indigo-400 text-indigo-200 font-bold' 
                                  : 'bg-indigo-500/20 border-indigo-500/30 text-indigo-300 hover:bg-indigo-500/30'
                              } transition-colors`}
                            >
                              #{t}
                            </a>
                          ))}
                          {entry.data.tags.length > 3 && (
                            <span class="text-xs text-slate-400">
                              +{entry.data.tags.length - 3}
                            </span>
                          )}
                        </div>
                      )}

                      {/* CVEs si existen */}
                      {'vulnerabilities' in entry.data && entry.data.vulnerabilities && entry.data.vulnerabilities.length > 0 && (
                        <div class="flex flex-wrap gap-2 justify-center mt-3">
                          {entry.data.vulnerabilities.slice(0, 2).map((cve: string) => (
                            <span class="text-xs px-3 py-1 bg-red-500/20 border border-red-500/30 text-red-300 rounded-full">
                              #{cve}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </>
                ) : (
                  <>
                    {/* Vista cl√°sica para blog posts */}
                    {entry.data.heroImage && (
                      <a href={`${baseUrl}/${actualSlug}`} class="card-image">
                        <img src={entry.data.heroImage} alt={entry.data.title} />
                      </a>
                    )}
                    <div class="card-content">
                      <div class="card-meta">
                        <span class="card-type">Blog</span>
                      </div>
                      <h2 class="card-title">
                        <a href={`${baseUrl}/${actualSlug}`}>
                          {entry.data.title}
                        </a>
                      </h2>
                      <p class="card-description">{entry.data.description}</p>
                      <div class="card-footer">
                        <time datetime={entry.data.pubDate.toISOString()}>
                          {formatDate(entry.data.pubDate, lang)}
                        </time>
                        {entry.data.tags && entry.data.tags.length > 0 && (
                          <div class="card-tags">
                            {entry.data.tags.slice(0, 3).map((t) => (
                              <a 
                                href={`/${lang}/tag/${t.toLowerCase().replace(/\s+/g, '-')}`}
                                class={`tag ${t.toLowerCase().replace(/\s+/g, '-') === tag.toLowerCase().replace(/\s+/g, '-') ? 'active' : ''}`}
                              >
                                {t}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </>
                )}
              </article>
            );
          })}
        </div>
      )}

      <div class="back-link-wrapper">
        <button onclick="window.history.back()" class="back-link">
          ‚Üê {lang === 'es' ? 'Volver atr√°s' : 'Go back'}
        </button>
      </div>
    </div>
  </main>
</Layout>

<style>
  .tag-page {
    min-height: calc(100vh - 16rem);
    padding: 4rem 1rem;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .tag-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--accent-color);
    color: white;
    border-radius: 2rem;
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .tag-badge svg {
    width: 20px;
    height: 20px;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-color);
    margin: 0;
  }

  .no-results {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
  }

  .entries-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 4rem;
  }

  .writeup-card {
    position: relative;
  }

  .writeup-card:hover.bg-gradient-to-br {
    border-color: var(--accent-color);
  }

  /* Blog card styles */
  .entry-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
  }

  .entry-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    border-color: var(--accent-color);
  }

  .card-image {
    display: block;
    width: 100%;
    height: 200px;
    overflow: hidden;
    position: relative;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .entry-card:hover .card-image img {
    transform: scale(1.05);
  }

  .card-content {
    padding: 1.5rem;
  }

  .card-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .card-type,
  .card-platform {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--tag-bg);
    color: var(--tag-text);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .card-platform {
    background: var(--badge-bg);
    color: var(--badge-text);
  }

  .card-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 0 0.75rem;
    line-height: 1.3;
  }

  .card-title a {
    color: var(--text-color);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .card-title a:hover {
    color: var(--accent-color);
  }

  .card-description {
    color: var(--text-muted);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
  }

  .card-footer time {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .card-tags {
    /* Using global tag container styles from global.css */
  }

  .tag {
    /* Using global tag styles from global.css */
  }

  .tag.active {
    background: rgba(99, 102, 241, 0.9);
    color: white;
    font-weight: 700;
    border-color: rgb(99, 102, 241);
  }

  :global(.dark) .tag.active {
    background: rgba(129, 140, 248, 0.9);
    color: rgb(17, 24, 39);
    border-color: rgb(129, 140, 248);
  }

  .back-link-wrapper {
    text-align: center;
    margin-top: 4rem;
  }

  .back-link {
    display: inline-block;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    font-size: 1.125rem;
    transition: color 0.2s ease;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    font-family: inherit;
  }

  .back-link:hover {
    color: var(--accent-hover);
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 1.75rem;
    }

    .entries-grid {
      grid-template-columns: 1fr;
    }
    
    .writeup-card .px-6 {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }

  /* Animaci√≥n para el glow */
  @keyframes pulse {
    0%, 100% {
      opacity: 0.75;
    }
    50% {
      opacity: 1;
    }
  }

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
